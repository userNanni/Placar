<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avaliador Avançado - OHMA</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Old+Standard+TT:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/pocketbase@0.19.0/dist/pocketbase.umd.js"></script>
  <style>
    body {
      font-family: 'Old Standard TT', serif;
      background: url('https://www.transparenttextures.com/patterns/old-paper.png'), #e8dcb8;
      color: #3a2c0a;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background: url('https://www.transparenttextures.com/patterns/parchment.png');
      border: 1px solid #8B4513;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 0 30px rgba(139, 69, 19, 0.5);
    }
    h1 {
      font-family: 'Cinzel', serif;
      text-align: center;
      margin-bottom: 20px;
    }
    select, input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #8B4513;
      border-radius: 5px;
      background: #fff8e1;
    }
    .fase {
      margin-bottom: 30px;
      border-top: 2px solid #8B4513;
      padding-top: 20px;
    }
    .fase h2 {
      font-family: 'Cinzel', serif;
      margin-bottom: 10px;
    }
    .item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .item input[type="text"] {
      flex: 2;
    }
    .item input[type="number"] {
      width: 80px;
    }
    .item input[type="checkbox"] {
      transform: scale(1.4);
    }
    button {
      background: #8B4513;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-family: 'Cinzel', serif;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background: #a05c2a;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Avaliador Avançado OHMA</h1>
  <select id="equipeSelect">
    <option selected disabled>Selecione uma equipe</option>
  </select>

  <div id="fases"></div>

  <button onclick="registrarPontuacoes()">Registrar Todas as Pontuações</button>
</div>

<script>
  const pb = new PocketBase("https://simplyheron.fly.dev");
  const fasesConfig = [
    { titulo: "Fase 1 - Prova", id: "fase1" },
    { titulo: "Fase 2 - Rodada de Perguntas", id: "fase2" },
    { titulo: "Fase 3 - Apresentação", id: "fase3" },
    { titulo: "Fase 4 - Rodada Final", id: "fase4" }
  ];

  async function carregarEquipes() {
    const equipes = await pb.collection("placar").getFullList({ sort: "equipe" });
    const select = document.getElementById("equipeSelect");
    equipes.forEach(eq => {
      const opt = document.createElement("option");
      opt.value = eq.id;
      opt.textContent = eq.equipe;
      select.appendChild(opt);
    });
  }

  function criarInterfaceFases() {
    const container = document.getElementById("fases");
    fasesConfig.forEach(fase => {
      const divFase = document.createElement("div");
      divFase.className = "fase";
      divFase.innerHTML = `<h2>${fase.titulo}</h2><div class="itens"></div>`;
      const botoes = document.createElement("button");
      botoes.textContent = "+ Adicionar Item";
      botoes.onclick = () => adicionarItem(divFase.querySelector(".itens"), fase.titulo);
      divFase.appendChild(botoes);
      container.appendChild(divFase);
    });
  }

  function adicionarItem(container, faseTitulo) {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <input type="text" placeholder="Nome da questão">
      <input type="number" placeholder="Pontos" min="0">
      <input type="checkbox" title="Marcar como correto">
    `;
    container.appendChild(div);
  }

  async function registrarPontuacoes() {
    const equipeId = document.getElementById("equipeSelect").value;
    if (!equipeId) return alert("Selecione uma equipe primeiro!");

    const todasFases = document.querySelectorAll(".fase");
    let totalAdicionado = 0;

    for (const fase of todasFases) {
      const faseTitulo = fase.querySelector("h2").textContent;
      const itens = fase.querySelectorAll(".item");

      for (const item of itens) {
        const nome = item.querySelector("input[type='text']").value;
        const pontos = parseInt(item.querySelector("input[type='number']").value) || 0;
        const marcado = item.querySelector("input[type='checkbox']").checked;

        const motivo = `${faseTitulo} - ${nome || 'Questão'}`;
        const pontuacaoFinal = marcado ? pontos : 0;

        await pb.collection("historico_pontos").create({
          equipe: equipeId,
          motivo,
          pontos: pontuacaoFinal
        });

        if (marcado) totalAdicionado += pontuacaoFinal;
      }
    }

    if (totalAdicionado > 0) {
      const equipe = await pb.collection("placar").getOne(equipeId);
      await pb.collection("placar").update(equipeId, { pontos: equipe.pontos + totalAdicionado });
    }

    alert("Pontuações registradas com sucesso!");
  }

  (async () => {
    await carregarEquipes();
    criarInterfaceFases();
  })();
</script>
</body>
</html>
